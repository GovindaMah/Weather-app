<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="images/x-icon" href="./images/favicon1.ico">

  <title>Advanced Weather Web</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>


  <!--------------------- STYLE ----------------->
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }


    body {
      display: flex;
      flex-direction: row;
      justify-content: center;
      min-height: 100vh;
      padding: 40px;
      gap: 60px;
      background: linear-gradient(to right, #74ebd5, #ACB6E5);
      transition: background 1s ease;
    }

    .divi1 {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .divi2 {
      position: top;

    }



    #map {
      width: 100%;
      height: 500px;
      border: 2px solid black;
      /* increase this value to make map taller */
      border-radius: 12px;
      /* optional rounded corners */
      margin: 20px 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      /* optional shadow */
    }

    #map:hover {
      transform: scale(1.05);
      /* 5% zoom on hover */
      z-index: 10;
      /* ‡§ä‡§™‡§∞ ‡§¶‡§ø‡§ñ‡•á */
    }


    .tab {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;

    }

    h1 {
      color: #222;
      /* Light mode -> dark text */
      text-align: center;
      margin-bottom: 15px;
      font-size: 28px;
      font-weight: bold;
    }

    /* Jab body pe dark-mode class ho */
    body.dark-mode h1 {
      color: #fff;
      /* Dark mode -> white text */
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.6);
      /* thoda shadow for clarity */
    }

    .search-box {
      display: flex;
      width: 100%;
      max-width: 400px;
    }

    .search-box input {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px 0 0 8px;
      outline: none;
    }

    .search-box button {
      padding: 10px 15px;
      border: none;
      background: #333;
      color: white;
      border-radius: 0 8px 8px 0;
      cursor: pointer;
      transition: background 0.3s;
    }

    .search-box button:hover {
      background: #555;
    }

    button.small-btn {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #444;
      color: white;
      transition: 0.3s;
    }

    button.small-btn:hover {
      background: #666;
    }

    #currentWeather,
    #extraDetails {
      display: none;
    }


    .weather,
    .extra {
      text-align: center;
      margin-bottom: 20px;
      background: rgba(255, 255, 255, 0.2);
      padding: 15px;
      border-radius: 12px;
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      width: 100%;
      max-width: 500px;
      animation: fadeIn 1s ease;
    }

    .forecast,
    .hourly {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      width: 100%;
      max-width: 800px;
    }

    .day,
    .hour {
      background: rgba(255, 255, 255, 0.25);
      padding: 15px;
      border-radius: 12px;
      backdrop-filter: blur(6px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      text-align: center;
      transition: transform 0.3s;
      animation: fadeInUp 0.5s ease;
    }

    .day:hover,
    .hour:hover {
      transform: scale(1.05);
    }

    .dark {
      background: linear-gradient(to right, #232526, #414345);
      color: white;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 600px) {
      h1 {
        font-size: 20px;
      }

      .search-box input {
        font-size: 14px;
      }

      .day,
      .hour {
        padding: 10px;
      }
    }
  </style>
</head>

<body>
  <!----------------- HTML ---------------------->
  <div class="divi1">
    <img src="./images/rainy-icon.gif" autoplay loop muted playsinline width="100" height="100"></img>
    <h1>üå§ Advanced Weather Web</h1>

    <div class="tab">
      <div class="controls">
        <button class="small-btn" onclick="getLocationWeather()">üìç Use My Location</button>
        <button class="small-btn" onclick="toggleUnit()">¬∞C / ¬∞F</button>
        <button class="small-btn" onclick="toggleDarkMode()">üåô Dark Mode</button>
      </div>

      <div class="search-box">
        <input type="text" id="cityInput" placeholder="Enter city name">
        <button onclick="getWeather()">Search</button>
      </div>

      <div class="weather" id="currentWeather"></div>
      <div class="extra" id="extraDetails"></div>
      <h2>üåç 5-Day Forecast</h2>
      <div class="forecast" id="forecast"></div>
      <h2>‚è≥ Next 12 Hours</h2>
      <div class="hourly" id="hourly"></div>

    </div>
  </div>

  <div class="divi2">
    <h2>üó∫ Select Location on Map</h2>
    <div id="map"
      style="height: 400px; width: 100%; max-width:800px; margin: 20px auto; border-radius:12px; overflow:hidden;">
    </div>
  </div>


  <script>
    // -----------------------------JS----------------------------
    const apiKey = "320c92c2318a6eddb907caa755fbdc4a"; // apna OpenWeather API key daalna
    let isCelsius = true;
    let darkMode = false;


    // Function to return colored circle for AQI
    function getAQIStatus(aqi) {
      let color = "";

      // OpenWeather AQI scale: 1 (Good) - 5 (Very Poor)
      switch (aqi) {
        case 1: color = "üü¢"; break;
        case 2: color = "üü°"; break;
        case 3: color = "üü†"; break;
        case 4: color = "üü§"; break;
        case 5: color = "üî¥"; break;
        default: color = "‚ö™Ô∏è"; x
      }

      // Return colored circle HTML
      return color;
    }

    // Convert ¬∞C <-> ¬∞F
    function convertTemp(temp) {
      return isCelsius ? temp : (temp * 9 / 5 + 32);
    }
    function toggleUnit() {
      isCelsius = !isCelsius;
      getWeather();
    }
    function toggleDarkMode() {
      darkMode = !darkMode;
      document.body.classList.toggle("dark", darkMode);
      document.body.style.color = darkMode ? "linear-gradient(to right, #232526, #414345)" : "linear-gradient(to right, #74ebd5, #010101FF)";
    }

    // Background change based on weather condition
    function setBackground(desc) {
      if (desc.includes("cloud")) document.body.style.background = "linear-gradient(to right, #bdc3c7, #2c3e50)";
      else if (desc.includes("rain")) document.body.style.background = "linear-gradient(to right, #00c6ff, #0072ff)";
      else if (desc.includes("clear")) document.body.style.background = "linear-gradient(to right, #fceabb, #f8b500)";
      else if (desc.includes("snow")) document.body.style.background = "linear-gradient(to right, #e6dada, #274046)";
      else document.body.style.background = "linear-gradient(to right, #74ebd5, #ACB6E5)";
    }

    async function getWeather(city = null) {
      if (!city) city = document.getElementById("cityInput").value;
      if (!city) { alert("Please enter a city name"); return; }

      try {
        // Current Weather
        const weatherResponse = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=metric`);
        const weatherData = await weatherResponse.json();
        if (weatherData.cod !== 200) { alert(weatherData.message); return; }

        document.getElementById("currentWeather").style.display = "block";
        document.getElementById("extraDetails").style.display = "block";

        const temp = convertTemp(weatherData.main.temp).toFixed(1);
        const unit = isCelsius ? "¬∞C" : "¬∞F";
        const desc = weatherData.weather[0].description;
        const icon = `http://openweathermap.org/img/wn/${weatherData.weather[0].icon}@2x.png`;

        setBackground(desc);

        document.getElementById("currentWeather").innerHTML = `
          <h2>${weatherData.name}, ${weatherData.sys.country}</h2>
          <img src="${icon}" alt="icon"/>
          <p>üå° ${temp} ${unit}</p>
          <p>${desc}</p>
        `;

        // Extra Details
        const lat = weatherData.coord.lat;
        const lon = weatherData.coord.lon;

        // pehle AQI fetch kar
        const aqiValue = await fetchAQI(lat, lon);

        document.getElementById("extraDetails").innerHTML = `
        <p>Feels Like: ${convertTemp(weatherData.main.feels_like).toFixed(1)} ${unit}</p>
        <p>Humidity: ${weatherData.main.humidity}%</p>
        <p>Wind: ${weatherData.wind.speed} m/s</p>
        <p>Sunrise: ${new Date(weatherData.sys.sunrise * 1000).toLocaleTimeString()}</p>
        <p>Sunset: ${new Date(weatherData.sys.sunset * 1000).toLocaleTimeString()}</p>
        <p>AQI: ${aqiValue} ${getAQIStatus(aqiValue)}</p>
        `;




        // Forecast Data
        const forecastResponse = await fetch(`https://api.openweathermap.org/data/2.5/forecast?q=${city}&appid=${apiKey}&units=metric`);
        const forecastData = await forecastResponse.json();

        // 5-day forecast
        const forecastDiv = document.getElementById("forecast");
        forecastDiv.innerHTML = "";
        const dailyData = forecastData.list.filter(item => item.dt_txt.includes("12:00:00"));
        dailyData.forEach(day => {
          const date = new Date(day.dt_txt);
          const temp = convertTemp(day.main.temp).toFixed(1);
          const icon = `http://openweathermap.org/img/wn/${day.weather[0].icon}@2x.png`;
          forecastDiv.innerHTML += `
            <div class="day">
              <h3>${date.toDateString()}</h3>
              <img src="${icon}" alt="icon"/>
              <p>${temp} ${unit}</p>
              <p>${day.weather[0].description}</p>
            </div>
          `;
        });

        // Hourly (next 12 hours)
        const hourlyDiv = document.getElementById("hourly");
        hourlyDiv.innerHTML = "";
        forecastData.list.slice(0, 4).forEach(hour => {
          const time = new Date(hour.dt_txt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const temp = convertTemp(hour.main.temp).toFixed(1);
          const icon = `http://openweathermap.org/img/wn/${hour.weather[0].icon}.png`;
          hourlyDiv.innerHTML += `
            <div class="hour">
              <h4>${time}</h4>
              <img src="${icon}" alt="icon"/>
              <p>${temp} ${unit}</p>
              <p>${hour.weather[0].description}</p>
            </div>
          `;
        });

        // Save to localStorage recent searches
        let recent = JSON.parse(localStorage.getItem("recentCities")) || [];
        if (!recent.includes(city)) {
          recent.unshift(city);
          if (recent.length > 5) recent.pop();
          localStorage.setItem("recentCities", JSON.stringify(recent));
        }
      } catch (err) {
        console.error("Error fetching weather:", err);
        alert("Failed to fetch weather. Try again later.");
      }
    }

    // Get location weather
    // Get location weather + forecast
    function getLocationWeather() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async (pos) => {
          const { latitude, longitude } = pos.coords;

          try {
            // Current Weather by coordinates
            const weatherRes = await fetch(
              `https://api.openweathermap.org/data/2.5/weather?lat=${latitude}&lon=${longitude}&appid=${apiKey}&units=metric`
            );
            const weatherData = await weatherRes.json();

            if (weatherData.cod !== 200) {
              alert(weatherData.message);
              return;
            }

            const cityName = weatherData.name;
            const country = weatherData.sys.country;

            // üëá ab normal getWeather() call me city pass karne ke bajaye,
            // directly forecast bhi coordinates se fetch karenge
            displayWeatherAndForecast(weatherData, latitude, longitude);

          } catch (err) {
            console.error("Error fetching location weather:", err);
            alert("Failed to fetch location weather.");
          }
        });
      } else {
        alert("Geolocation not supported");
      }
    }

    // Function to fetch AQI
    async function fetchAQI(lat, lon) {
      const apiKey = "320c92c2318a6eddb907caa755fbdc4a";
      const aqiUrl = `https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${apiKey}`;

      try {
        const response = await fetch(aqiUrl);
        const data = await response.json();
        console.log("AQI Response:", data); // Debug log

        if (data.list && data.list.length > 0) {
          return data.list[0].main.aqi;
        } else {
          return "N/A";
        }
      } catch (error) {
        console.error("Error fetching AQI:", error);
        return "N/A";
      }
    }

    // Initialize map
    const map = L.map('map').setView([20.5937, 78.9629], 5); // Default India center

    // Tile layer (OpenStreetMap free)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Marker variable
    let marker;

    // When user clicks on map
    map.on('click', async function (e) {
      const lat = e.latlng.lat;
      const lon = e.latlng.lng;

      // Remove old marker
      if (marker) map.removeLayer(marker);

      // Add new marker
      marker = L.marker([lat, lon]).addTo(map);

      try {
        // Current Weather
        const res = await fetch(
          `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric`
        );
        const weatherData = await res.json();
        if (weatherData.cod !== 200) {
          alert(weatherData.message);
          return;
        }

        const temp = convertTemp(weatherData.main.temp).toFixed(1);
        const unit = isCelsius ? "¬∞C" : "¬∞F";
        const desc = weatherData.weather[0].description;
        const icon = `http://openweathermap.org/img/wn/${weatherData.weather[0].icon}@2x.png`;

        document.getElementById("currentWeather").style.display = "block";
        document.getElementById("extraDetails").style.display = "block";

        document.getElementById("currentWeather").innerHTML = `
      <h2>${weatherData.name}, ${weatherData.sys.country}</h2>
      <img src="${icon}" alt="icon"/>
      <p>üå° ${temp} ${unit}</p>
      <p>${desc}</p>
    `;

        // AQI fetch
        const aqiValue = await fetchAQI(lat, lon);

        document.getElementById("extraDetails").innerHTML = `
      <p>Feels Like: ${convertTemp(weatherData.main.feels_like).toFixed(1)} ${unit}</p>
      <p>Humidity: ${weatherData.main.humidity}%</p>
      <p>Wind: ${weatherData.wind.speed} m/s</p>
      <p>Sunrise: ${new Date(weatherData.sys.sunrise * 1000).toLocaleTimeString()}</p>
      <p>Sunset: ${new Date(weatherData.sys.sunset * 1000).toLocaleTimeString()}</p>
      <p>AQI Index: ${aqiValue} ${getAQIStatus(aqiValue)}</p>
    `;



        // Forecast (5-day)
        const forecastResponse = await fetch(
          `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric`
        );
        const forecastData = await forecastResponse.json();

        // 5-day forecast (12:00 noon ka data)
        const forecastDiv = document.getElementById("forecast");
        forecastDiv.innerHTML = "";
        const dailyData = forecastData.list.filter(item => item.dt_txt.includes("12:00:00"));
        dailyData.forEach(day => {
          const date = new Date(day.dt_txt);
          const temp = convertTemp(day.main.temp).toFixed(1);
          const icon = `http://openweathermap.org/img/wn/${day.weather[0].icon}@2x.png`;
          forecastDiv.innerHTML += `
        <div class="day">
          <h3>${date.toDateString()}</h3>
          <img src="${icon}" alt="icon"/>
          <p>${temp} ${unit}</p>
          <p>${day.weather[0].description}</p>
        </div>
      `;
        });

        // Hourly (next 12 hours)
        const hourlyDiv = document.getElementById("hourly");
        hourlyDiv.innerHTML = "";
        forecastData.list.slice(0, 4).forEach(hour => {
          const time = new Date(hour.dt_txt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const temp = convertTemp(hour.main.temp).toFixed(1);
          const icon = `http://openweathermap.org/img/wn/${hour.weather[0].icon}.png`;
          hourlyDiv.innerHTML += `
        <div class="hour">
          <h4>${time}</h4>
          <img src="${icon}" alt="icon"/>
          <p>${temp} ${unit}</p>
          <p>${hour.weather[0].description}</p>
        </div>
      `;
        });

      } catch (err) {
        console.error("Error fetching map weather:", err);
        alert("Failed to fetch weather for selected location.");
      }
    });

  </script>
</body>

</html>